pipeline {
  agent { label 'docker' }
  parameters {
    booleanParam(name: 'RUN_TESTS', defaultValue: true)
    string(name: 'TAG', defaultValue: 'latest')
  }

  environment {
    DOCKER_REPO="anestesia01/goapp"
    PRJ_NAME="simple-go"
    GIT_URL="git@github.com:AnastasiyaGapochkina01/dos-29-cicd_01.git"
    DOCKER_TOKEN=credentials('docker_token')
  }

  stages {
    stage('Clone repo') {
      steps {
        sh """
          if [ -d ${env.PRJ_NAME}/.git ]; then
            echo "Project repo exists"
            cd ${env.PRJ_NAME}
            git pull
          else
            echo "No project repo"
            git clone ${env.GIT_URL} ${env.PRJ_NAME}
          fi
        """
      }
    }

    stage('Build image') {
      steps {
        script {
          sh """
            cd ${env.PRJ_NAME}
            docker build -t ${env.DOCKER_REPO}:${params.TAG} ./
          """
        }
      }
    }

    stage('Run tests') {
      when {
        expression { params.RUN_TESTS == true }
      }
      steps {
        script {
          sh """
            cd ${env.PRJ_NAME}
            go mod init simple-go
            go test ./
          """
        }
      }
    }

    stage('Push image to docker hub') {
      steps {
        script {
          sh """
            docker login -u anestesia01 -p ${env.DOCKER_TOKEN}
            docker push ${env.DOCKER_REPO}:${params.TAG}
            docker logout
          """
        }
      }
    }
  }
}
